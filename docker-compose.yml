version: '3.8'

services:
  # ─────────────────────────────────────────
  # PostgreSQL Database
  # ─────────────────────────────────────────
  db:
    image: postgres:15
    container_name: migestion-db
    restart: unless-stopped
    environment:
      POSTGRES_DB: ${DB_NAME:-migestion}
      POSTGRES_USER: ${DB_USER:-migestion}
      POSTGRES_PASSWORD: ${DB_PASSWORD:-password}
    ports:
      - '${DB_PORT:-5432}:5432'
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./docker/postgres/init:/docker-entrypoint-initdb.d
    healthcheck:
      test: ['CMD-SHELL', 'pg_isready -U ${DB_USER:-migestion} -d ${DB_NAME:-migestion}']
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - migestion-network

  # ─────────────────────────────────────────
  # Redis Cache
  # ─────────────────────────────────────────
  redis:
    image: redis:7-alpine
    container_name: migestion-redis
    restart: unless-stopped
    ports:
      - '${REDIS_PORT:-6379}:6379'
    volumes:
      - redis_data:/data
    command: redis-server --appendonly yes
    healthcheck:
      test: ['CMD', 'redis-cli', 'ping']
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - migestion-network

  # ─────────────────────────────────────────
  # API Backend (Development)
  # ─────────────────────────────────────────
  api:
    build:
      context: .
      dockerfile: docker/Dockerfile.api
    container_name: migestion-api
    restart: unless-stopped
    ports:
      - '${API_PORT:-3000}:3000'
    environment:
      NODE_ENV: development
      DATABASE_URL: mysql://${DB_USER:-migestion}:${DB_PASSWORD:-migestion123}@db:3306/${DB_NAME:-migestion}
      REDIS_URL: redis://redis:6379
      JWT_ACCESS_SECRET: ${JWT_ACCESS_SECRET:-dev-access-secret-change-in-production}
      JWT_REFRESH_SECRET: ${JWT_REFRESH_SECRET:-dev-refresh-secret-change-in-production}
    volumes:
      - ./packages/api:/app/packages/api
      - /app/packages/api/node_modules
    depends_on:
      db:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - migestion-network

  # ─────────────────────────────────────────
  # Web Frontend (Development)
  # ─────────────────────────────────────────
  web:
    build:
      context: .
      dockerfile: docker/Dockerfile.web
    container_name: migestion-web
    restart: unless-stopped
    ports:
      - '${WEB_PORT:-5173}:5173'
    environment:
      VITE_API_URL: http://localhost:${API_PORT:-3000}
    volumes:
      - ./packages/web:/app/packages/web
      - /app/packages/web/node_modules
    depends_on:
      - api
    networks:
      - migestion-network

  # ─────────────────────────────────────────
  # Backup Cron Service
  # ─────────────────────────────────────────
  backup:
    image: node:20-alpine
    container_name: migestion-backup
    restart: unless-stopped
    volumes:
      - ./packages/api:/app/packages/api:ro
      - ./docker/backup/entrypoint.sh:/entrypoint.sh:ro
      - backups_data:/backups
      - ./docker/backup/.env:/app/.env:ro
    environment:
      NODE_ENV: production
      DATABASE_URL: mysql://${DB_USER:-migestion}:${DB_PASSWORD:-migestion123}@db:3306/${DB_NAME:-migestion}
      DB_HOST: db
      DB_PORT: 3306
      DB_USER: ${DB_USER:-migestion}
      DB_PASSWORD: ${DB_PASSWORD:-migestion123}
      DB_NAME: ${DB_NAME:-migestion}
      BACKUP_RETENTION_DAYS: ${BACKUP_RETENTION_DAYS:-30}
      BACKUP_SCHEDULE: ${BACKUP_SCHEDULE:-0 2 * * *}
    command: sh /entrypoint.sh
    depends_on:
      db:
        condition: service_healthy
    networks:
      - migestion-network
    profiles:
      - backup

volumes:
  postgres_data:
    driver: local
  redis_data:
    driver: local
  backups_data:
    driver: local

networks:
  migestion-network:
    driver: bridge
